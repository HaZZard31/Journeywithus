<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>මගේ හදවතේ නිවහන</title>
    <!-- Load Tailwind CSS --><script src="https://cdn.tailwindcss.com"></script>
    <!-- Configure Tailwind for Custom Colors --><script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rose-gold': '#A55B66', 
                        'soft-pink': '#F7E7E8', 
                        'deep-red': '#C0392B',  
                        'light-bg': '#FFFCF9', 
                    },
                    fontFamily: {
                        script: ['Great Vibes', 'cursive'],
                        sans: ['Inter', 'Noto Sans Sinhala', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom font import for the elegant script look */
        @import url('https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap');
        
        /* --- ANIMATED BACKGROUND STYLING (Romantic Gradient) --- */
        body {
            /* Sets up the warm, romantic gradient colors used in the animation */
            background: linear-gradient(-45deg, #F7E7E8, #FFFCF9, #F7E7E8, var(--rose-gold-css, #A55B66));
            background-size: 400% 400%; 
            animation: gradientMove 15s ease infinite; 
            
            font-family: 'Inter', 'Noto Sans Sinhala', 'Iskoola Pota', sans-serif;
            position: relative; 
        }

        /* Dynamically set the CSS variable based on the Tailwind config for the gradient */
        :root {
            --rose-gold-css: #A55B66;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* FIX: Ensure content sections are fully opaque (solid background) for high text contrast */
        .bg-light-bg {
            background-color: #FFFCF9; /* Fully opaque light background */
            position: relative; 
            z-index: 10; 
        }
        .bg-white {
            background-color: #FFFFFF; /* Fully opaque white background */
            position: relative;
            z-index: 10;
        }
        /* Make deep-red section fully opaque for contrast */
        .bg-deep-red {
            position: relative;
            z-index: 10;
        }
        
        /* --- END NEW STYLING --- */

        .fade-in {
            animation: fadeIn 3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .heart-beat {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* --- KISS EMOJI ANIMATION STYLES (Slow) --- */
        .kiss-emoji {
            position: absolute;
            font-size: 2.5rem; 
            opacity: 0;
            user-select: none; 
            pointer-events: none; 
            animation: kiss-animation 4s ease-out forwards; 
            z-index: 1000; 
        }

        @keyframes kiss-animation {
            0% {
                transform: translate(0, 0) scale(0.5);
                opacity: 0.8;
            }
            100% {
                transform: translate(var(--final-x, 0px), var(--final-y, -400px)) scale(1.5); 
                opacity: 0; 
            }
        }
    </style>
    <!-- Font Awesome for icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body class="font-sans text-gray-900">

    <!-- Scroll Fade Overlay: This changes opacity on scroll to simulate theme fade -->
    <div id="scroll-overlay" class="fixed inset-0 bg-white z-[5] pointer-events-none" style="opacity: 0;"></div>

    <!-- Hero Section: Main Message --><section class="bg-light-bg py-24 px-6 md:px-12 shadow-xl">
        <div class="max-w-4xl mx-auto text-center fade-in">
            <!-- සිංහල: ආමන්ත්‍රණය --><p class="text-3xl text-rose-gold mb-4 tracking-wider">මාගේ ආදරණීය මාධවී වෙතට,</p>
            <h1 class="font-script text-6xl sm:text-7xl md:text-9xl text-deep-red leading-tight mb-8">
                "ඔබ මාගේ හුස්මයි"
            </h1>
            <!-- සිංහල: ප්‍රධාන පණිවිඩය --><p id="main-message-text" class="text-xl md:text-2xl text-gray-600 max-w-2xl mx-auto">
                ඔබ සමඟ ගත කරන සෑම දිනක්ම මාගේ ජීවිතයේ හොඳම දවසයි. මා ඔබ කෙරෙහි ඇති ආදරයේ කොටසක් රඳවා තබා ගැනීමට මෙම කුඩා අවකාශය නිර්මාණය කළෙමි.
            </p>
            <div class="mt-10 space-y-4">
                <!-- සිංහල: රහසක් සඳහා බොත්තම -->
                <button id="reveal-message" class="px-8 py-4 bg-rose-gold text-white font-bold rounded-full shadow-lg hover:bg-deep-red transition duration-300 heart-beat focus:outline-none focus:ring-4 focus:ring-rose-gold focus:ring-opacity-50">
                    <i class="fas fa-heart mr-2"></i> රහසක් සඳහා ඔබන්න!
                </button>
                
                <!-- NEW: TTS Button (Gemini API Integration) -->
                <button id="tts-button" class="block w-full md:w-auto mx-auto px-8 py-3 bg-white text-rose-gold border-2 border-rose-gold font-bold rounded-full shadow-lg hover:bg-soft-pink transition duration-300 focus:outline-none">
                    <i class="fas fa-volume-up mr-2"></i> ✨ මගේ ආදරය අසන්න
                </button>
                <div id="tts-status" class="text-sm text-rose-gold mt-2 min-h-[20px]"></div>
            </div>
        </div>
    </section>

    <!-- Secret Message Area --><section id="secret-message" class="hidden py-10 px-6 text-center bg-deep-red text-white">
        <div class="max-w-3xl mx-auto">
            <!-- සිංහල: රහස් පණිවිඩය --><h2 class="text-3xl md:text-4xl font-bold mb-4">ඔබ මා දන්නා ලස්සනම ආත්මයයි.</h2>
            <p class="text-lg">
                මම සැමවිටම ඔබ වෙනුවෙන් සිටීමට, ඔබ සමඟ සිනාසීමට, සහ අදට වඩා හෙට ඔබට ආදරය කිරීමට පොරොන්දු වෙමි. ඔබ ඔබම වීම ගැන ස්තූතියි.
            </p>
        </div>
    </section>

    <!-- Reasons I Love You Section 1 (5 Reasons) --><section class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <!-- සිංහල: හේතු සිරස්තලය --><h2 class="text-5xl font-script text-center text-rose-gold mb-16 fade-in">මා ඔබට මෙතරම් ආදරය කරන පුංචි හේතු පහක්</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-8 text-center">
                
                <!-- සිංහල: හේතුව 1 - ඔබේ සිනහව (Smile Wink) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-face-smile-wink text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">ඔබේ සිනහව</h3>
                    <p class="text-sm text-gray-500">සියල්ලම මොහොතකට අමතක කරවන ඔබේ සිනහව.</p>
                </div>
                
                <!-- සිංහල: හේතුව 2 - ඔබේ කරුණාව (Hand Holding Heart) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-hand-holding-heart text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">ඔබේ කරුණාව</h3>
                    <p class="text-sm text-gray-500">මා ගැන ඔබේ සිතේ ඇති කරුණාව හා ලෙන්ගතුකම.</p>
                </div>

                <!-- සිංහල: හේතුව 3 - ඔබේ ආශාව (Passion - UPDATED ICON) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-fire text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">ඔබේ ආශාව</h3>
                    <p class="text-sm text-gray-500">මා ආදරය කරන දේට ඔබ ගෙන එන ආලෝකය.</p>
                </div>
                
                <!-- සිංහල: හේතුව 4 - අපේ මොහොතවල් (Calendar Days) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-calendar-days text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">අපේ මොහොතවල්</h3>
                    <p class="text-sm text-gray-500">අප බෙදා ගන්නා සරල, නිහඬ අවස්ථා පවා.</p>
                </div>
                
                <!-- සිංහල: හේතුව 5 - ඔබ මාගේ ගැලපීමයි (Infinity) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-infinity text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">ඔබ මාගේ ගැලපීමයි</h3>
                    <p class="text-sm text-gray-500">ඔබ මාගේ ජීවිතයේ සෑම කොටසක්ම පරිපූර්ණ ලෙස සම්පූර්ණ කරයි.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Our Milestones Section (New Section) --><section class="py-20 px-6 bg-light-bg">
        <div class="max-w-3xl mx-auto">
            <h2 class="text-5xl font-script text-center text-deep-red mb-16">අපේ සන්ධිස්ථාන</h2>
            
            <!-- Timeline Item 1 --><div class="relative mb-8 pl-10 border-l-4 border-rose-gold">
                <div class="absolute -left-3 top-0 h-6 w-6 bg-rose-gold rounded-full shadow-md flex items-center justify-center text-white"><i class="fas fa-star text-xs"></i></div>
                <p class="text-sm text-gray-500">ජනවාරි 09, 2025</p>
                <h3 class="text-xl font-bold text-gray-800">අපේ පළමු හමුව</h3>
                <p class="text-sm text-gray-600">මේ දවස අපේ කතාවේ ආරම්භයයි.</p>
            </div>

            <!-- Timeline Item 2 --><div class="relative mb-8 pl-10 border-l-4 border-rose-gold">
                <div class="absolute -left-3 top-0 h-6 w-6 bg-rose-gold rounded-full shadow-md flex items-center justify-center text-white"><i class="fas fa-heart text-xs"></i></div>
                <p class="text-sm text-gray-500">ජූනි 19, 2025</p>
                <h3 class="text-xl font-bold text-gray-800">මා සැබෑවටම ඔබට ආදරය කරන බවට දැනගත් මොහොත</h3>
                <p class="text-sm text-gray-600">ඔබට සදාකාලිකව ආදරය කිරීමට පොරොන්දු වූ දවස.</p>
            </div>
            
            <!-- Timeline Item 3 --><div class="relative pl-10 border-l-4 border-rose-gold">
                <div class="absolute -left-3 top-0 h-6 w-6 bg-rose-gold rounded-full shadow-md flex items-center justify-center text-white"><i class="fas fa-kiss text-xs"></i></div>
                <p class="text-sm text-gray-500">ඔක්තෝම්බර් 25, 2025</p>
                <h3 class="text-xl font-bold text-gray-800">ඔබට දුන් පළමු හාදුව</h3>
                <p class="text-sm text-gray-600">අආදරයේ අරුත පෙන්වා දුන් ඒ සොඳුරු මොහොත.</p>
            </div>
            <!-- Add more milestones here if needed for extra length --></div>
    </section>

    <!-- Reasons I Love You Section 2 (5 More Reasons - Updated Icons) --><section class="py-20 px-6">
        <div class="max-w-6xl mx-auto">
            <!-- සිංහල: හේතු සිරස්තලය --><h2 class="text-5xl font-script text-center text-rose-gold mb-16 fade-in">ඔබේ ජීවිතයේ සුන්දරත්වය</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-5 gap-8 text-center">
                
                <!-- සිංහල: හේතුව 6 - ඔබගේ සිහින (Dreams - UPDATED ICON) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-lightbulb text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">ඔබගේ සිහින</h3>
                    <p class="text-sm text-gray-500">ඒවා සැබෑ කර ගැනීමට ඇති ඔබේ කැපවීම.</p>
                </div>
                
                <!-- සිංහල: හේතුව 7 - ඔබේ හඬ (Voice - UPDATED ICON) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-microphone-lines text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">ඔබේ හඬ</h3>
                    <p class="text-sm text-gray-500">මට කිසිදා එපා නොවන ලොව එකම ශබ්දය.</p>
                </div>

                <!-- සිංහල: හේතුව 8 - උදව් කිරීම (Helping - UPDATED ICON) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-hand-holding-medical text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">උදව් කිරීම</h3>
                    <p class="text-sm text-gray-500">අනිත් අයට උදව් කිරීමට ඔබ දක්වන උනන්දුව.</p>
                </div>
                
                <!-- සිංහල: හේතුව 9 - සතුටු බව (Laughter) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-grin-squint text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">සතුටු බව</h3>
                    <p class="text-sm text-gray-500">ඔබ සැමවිටම සතුටින් සිටින ආකාරය.</p>
                </div>
                
                <!-- සිංහල: හේතුව 10 - නින්දට යාම (Moon) --><div class="p-6 rounded-xl bg-white shadow-lg transition duration-300 hover:shadow-2xl">
                    <i class="fas fa-moon text-4xl text-rose-gold mb-4"></i>
                    <h3 class="text-xl font-bold mb-2">නින්දට යාම</h3>
                    <p class="text-sm text-gray-500">නිදිමතව සිටින විටත් ඔබගේ ලස්සන පෙනුම.</p>
                </div>
            </div>
        </div>
    </section>
    
    <!-- Photo Gallery Placeholder Section (Updated: Base64 Instructions Removed) --><section class="py-20 px-6 bg-light-bg">
        <div class="max-w-6xl mx-auto">
            <!-- සිංහල: ගැලරි සිරස්තලය --><h2 class="text-5xl font-script text-center text-rose-gold mb-12">අපේ ප්‍රියතම මතකයන් (පෞද්ගලික)</h2>
            <!-- Instruction -->
            <p class="text-center text-gray-600 mb-10">
                (මෙය ඔබගේ ඡායාරූප වෙනුවට තබා ඇති ස්ථාන මාරු රූපයන්ය. ඔබට අවශ්‍ය නම්, මෙම කේතය සංස්කරණය කර ඔබේම පින්තූර URL එකක් ඇතුළත් කළ හැකිය.)
            </p>
            
            <!-- Photo placeholders remain the same -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                
                <!-- ඡායාරූපය 1 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+1" 
                         alt="අපගේ පළමු හමුව" 
                         class="w-full h-full object-cover">
                </div>
                
                <!-- ඡායාරූපය 2 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+2" 
                         alt="අපගේ නිවාඩු චාරිකාව" 
                         class="w-full h-full object-cover">
                </div>
                
                <!-- ඡායාරූපය 3 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+3" 
                         alt="විනෝදජනක රාත්‍රියක්" 
                         class="w-full h-full object-cover">
                </div>
                
                <!-- ඡායාරූපය 4 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+4" 
                         alt="සතුටු මොහොතක්" 
                         class="w-full h-full object-cover">
                </div>
            </div>
            
            <!-- Second Row of Photos (4) -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                
                <!-- ඡායාරූපය 5 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+5" 
                         alt="තවත් මතකයක්" 
                         class="w-full h-full object-cover">
                </div>
                
                <!-- ඡායාරූපය 6 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+6" 
                         alt="විශේෂ දිනයක්" 
                         class="w-full h-full object-cover">
                </div>
                
                <!-- ඡායාරූපය 7 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+7" 
                         alt="අපේ ලෝකය" 
                         class="w-full h-full object-cover">
                </div>
                
                <!-- ඡායාරූපය 8 -->
                <div class="rounded-lg overflow-hidden shadow-lg transition duration-300 hover:scale-[1.02] h-64 md:h-96">
                    <!-- Placeholder: Use a mock URL -->
                    <img src="https://placehold.co/600x400/A55B66/FFFFFF?text=ඡායාරූපය+8" 
                         alt="අපේ ආදරය" 
                         class="w-full h-full object-cover">
                </div>
            </div>
        </div>
    </section>

    <!-- Our Tomorrow Section (Future Promises - LLM Feature) --><section class="py-20 px-6 bg-deep-red text-white text-center">
        <div class="max-w-4xl mx-auto">
            <h2 class="text-5xl font-script mb-8">අපේ හෙට දවස</h2>
            <p class="text-lg mb-4" id="future-promise-main-text">
                අපේ මේ ආදරණීය ගමනේදී, මම ඔබ සමඟ සැමවිටම සිටින බවට මම පොරොන්දු වෙනවා. ඔබේ සියලු සිහින සැබෑ කර ගැනීමටත්, මේ ලෝකයේ ඇති ලස්සනම තැන් ඔබට පෙන්වීමටත්, අපේ ජීවිතය සිනහවෙන් හා ප්‍රීතියෙන් පුරවා ගැනීමටත් මම සූදානම්.
            </p>
            <p class="text-2xl font-bold mt-6">
                මම ඔබට සදහටම ආදරෙයි.
            </p>

            <!-- NEW: Promise Generator Button and Output (Gemini API Integration) -->
            <button id="generate-promise" class="mt-8 px-8 py-3 bg-white text-deep-red font-bold rounded-full shadow-lg hover:bg-rose-gold hover:text-white transition duration-300 focus:outline-none focus:ring-4 focus:ring-white focus:ring-opacity-50">
                <i class="fas fa-magic mr-2"></i> ✨ නව පොරොන්දුවක් සාදන්න
            </button>

            <div id="generated-promise-output" class="mt-8 p-6 bg-deep-red border-2 border-white rounded-xl shadow-inner text-lg italic text-soft-pink min-h-[50px]">
                <!-- Generated promise will appear here -->
            </div>
        </div>
    </section>

    <!-- Footer: Signature --><footer class="py-12 px-6 text-center bg-rose-gold text-white">
        <!-- සිංහල: අත්සන --><p class="text-2xl mb-2">සැමදාටම සහ සදහටම,</p>
        <p class="font-script text-5xl">ජයනිඳු</p>
    </footer>

    <!-- JavaScript for the Interactive Message, Kiss Emojis, and LLM/TTS Features -->
    <script>
        // --- Gemini API Configuration ---
        // ****** වැදගත්: ඔබ මෙය VS Code හෝ local browser එකක ධාවනය කරන්නේ නම්,
        // ****** ඔබේම API යතුර මෙහි ඇතුළත් කළ යුතුය. 
        // ****** ඔබට දී ඇති යතුර දැන් ඇතුල් කර ඇත: AIzaSyB11_E1o3BNKiZou1bKF-UvebCHNrgJbS0
        const API_KEY = "AIzaSyB11_E1o3BNKiZou1bKF-UvebCHNrgJbS0"; 
        const TEXT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const TTS_MODEL = "gemini-2.5-flash-preview-tts";

        // --- Utility Functions for TTS (PCM to WAV conversion) ---

        // Converts a base64 string to an ArrayBuffer
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        // Converts signed 16-bit PCM audio data to a standard WAV Blob
        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bytesPerSample = 2; // 16-bit PCM
            const blockAlign = numChannels * bytesPerSample;
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * bytesPerSample;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            
            // Helper function to write a string to the DataView
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }

            /* RIFF header */
            writeString(view, 0, 'RIFF'); // ChunkID
            view.setUint32(4, 36 + dataSize, true); // ChunkSize
            writeString(view, 8, 'WAVE'); // Format

            /* FMT sub-chunk */
            writeString(view, 12, 'fmt '); // Subchunk1ID
            view.setUint32(16, 16, true); // Subchunk1Size (16 for PCM)
            view.setUint16(20, 1, true); // AudioFormat (1 for PCM)
            view.setUint16(22, numChannels, true); // NumChannels
            view.setUint32(24, sampleRate, true); // SampleRate
            view.setUint32(28, byteRate, true); // ByteRate
            view.setUint16(32, blockAlign, true); // BlockAlign
            view.setUint16(34, 16, true); // BitsPerSample (16-bit)

            /* DATA sub-chunk */
            writeString(view, 36, 'data'); // Subchunk2ID
            view.setUint32(40, dataSize, true); // Subchunk2Size

            // Write PCM data
            let offset = 44;
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true); // Signed 16-bit little-endian
                offset += 2;
            }

            return new Blob([view], { type: 'audio/wav' });
        }
        
        // --- Exponential Backoff Fetcher (UPDATED FOR 'unregistered networks' error) ---
        async function fetchWithRetry(url, options, retries = 3) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorBody = await response.json();
                        const errorMessage = errorBody.error?.message || `HTTP error! status: ${response.status}`;
                        
                        // Check for errors we should retry on (rate limiting, API key/auth issues, generic fetch failures)
                        if (i < retries - 1 && (
                            errorMessage.includes('Rate limit') || 
                            errorMessage.includes('API Key') || 
                            errorMessage.includes('unregistered networks')
                        )) {
                             // Log retries internally, but use exponential delay
                            const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue; // Go to next retry attempt
                        }
                        // Specifically check for the 'unregistered callers' error and exit retries if API_KEY is empty
                        if (errorMessage.includes('unregistered callers') && API_KEY === "") {
                            throw new Error("Method doesn't allow unregistered callers (callers without established identity). Please use API Key or other form of API consumer identity to call this API.");
                        }
                        
                        throw new Error(errorMessage); 
                    }
                    return response;
                } catch (error) {
                    // Check for hard network failures (e.g., DNS resolution failed)
                    if (i < retries - 1 && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError'))) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        throw error;
                    }
                }
            }
            throw new Error("Failed to fetch after multiple retries.");
        }


        // --- TTS Generation Function (Feature 1) ---
        async function generateTTS() {
            const ttsButton = document.getElementById('tts-button');
            const ttsStatus = document.getElementById('tts-status');
            const mainMessageElement = document.getElementById('main-message-text');

            if (!mainMessageElement) {
                ttsStatus.textContent = 'දෝෂය: ප්‍රධාන පණිවිඩය සොයාගත නොහැක.';
                return;
            }
            
            const userPrompt = mainMessageElement.textContent.trim();
            if (!userPrompt) {
                ttsStatus.textContent = 'දෝෂය: කතා කිරීමට පෙළක් නොමැත.';
                return;
            }
            
            if (API_KEY === "") {
                ttsStatus.textContent = 'සම්බන්ධතා දෝෂයක්: API යතුර හිස්ය. කරුණාකර යතුර ඇතුළු කරන්න.';
                return;
            }

            // Disable button and show loading
            ttsButton.disabled = true;
            const originalText = ttsButton.innerHTML;
            ttsButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ශබ්දය ජනනය වෙමින් පවතී...'; 
            ttsStatus.textContent = 'ශබ්ද ගොනුව සූදානම් කරමින්...';

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${API_KEY}`;
                
                // Using 'Fenrir' (Excitable) voice
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Fenrir" }
                            }
                        }
                    },
                    model: TTS_MODEL
                };

                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const rateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;

                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    audio.play();
                    
                    ttsStatus.textContent = 'ආදරය ඇසෙයි! (Playing)';
                    audio.onended = () => {
                        ttsStatus.textContent = 'සවන් දීම අවසන්.';
                    };

                } else {
                    console.error("Invalid TTS response structure:", result);
                    ttsStatus.textContent = 'ශබ්ද ගොනුව ජනනය කිරීමට නොහැකි විය. (Invalid response)';
                }

            } catch (error) {
                console.error("TTS API Error:", error);
                // Improved user feedback for API failure
                ttsStatus.textContent = `සම්බන්ධතා දෝෂයක්: ${error.message}. කරුණාකර තත්පර කිහිපයකින් නැවත උත්සාහ කරන්න.`;
            } finally {
                ttsButton.disabled = false;
                ttsButton.innerHTML = originalText;
            }
        }

        // --- Promise Generation Function (LLM Text) (Feature 2) ---
        async function generatePromise() {
            const generateButton = document.getElementById('generate-promise');
            const outputDiv = document.getElementById('generated-promise-output');
            
            if (API_KEY === "") {
                outputDiv.innerHTML = '<p class="text-soft-pink">සම්බන්ධතා දෝෂයක්: API යතුර හිස්ය. කරුණාකර යතුර ඇතුළු කරන්න.</p>';
                return;
            }

            // Disable button and show loading
            generateButton.disabled = true;
            const originalText = generateButton.innerHTML;
            generateButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> පොරොන්දුව සාදමින්...';
            outputDiv.innerHTML = '<p>ආදර පොරොන්දුවක් ලියමින්...</p>';

            try {
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${TEXT_MODEL}:generateContent?key=${API_KEY}`;
                
                const systemPrompt = "You are a deeply romantic and eloquent Sri Lankan lover. Your task is to generate a single, unique, and heartfelt future promise for a long-term relationship. The promise MUST be written entirely in the Sinhala language, using formal and poetic phrasing. Do not include any introductory phrases or context, only the promise itself. Use Sinhala characters only.";
                
                const userQuery = "Generate a profound future promise focusing on shared dreams, unconditional support, and everlasting togetherness.";

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: { parts: [{ text: systemPrompt }] },
                };

                const response = await fetchWithRetry(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                const generatedText = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (generatedText) {
                    outputDiv.innerHTML = `<p class="text-white">${generatedText}</p>`;
                } else {
                    outputDiv.innerHTML = '<p class="text-soft-pink">පොරොන්දුවක් සාදීමට නොහැකි විය. නැවත උත්සාහ කරන්න. (No output)</p>';
                }

            } catch (error) {
                console.error("LLM API Error:", error);
                // Improved user feedback for API failure
                outputDiv.innerHTML = `<p class="text-soft-pink">සම්බන්ධතා දෝෂයක්: ${error.message}. කරුණාකර තත්පර කිහිපයකින් නැවත උත්සාහ කරන්න.</p>`;
            } finally {
                generateButton.disabled = false;
                generateButton.innerHTML = originalText;
            }
        }

        
        // --- Interactive Kiss Emojis (Original Functionality) ---
        document.getElementById('reveal-message').addEventListener('click', function() {
            const secretMessage = document.getElementById('secret-message');
            // Toggle visibility using Tailwind classes
            if (secretMessage.classList.contains('hidden')) {
                secretMessage.classList.remove('hidden');
                // Optional: Scroll to the message smoothly
                secretMessage.scrollIntoView({ behavior: 'smooth' });
            } else {
                secretMessage.classList.add('hidden');
            }
            // --- Call the function to create kiss emojis ---
            for (let i = 0; i < 15; i++) { // Increased count to 15 for better coverage
                createKissEmoji();
            }
        });

        function createKissEmoji() {
            const emoji = document.createElement('span');
            emoji.classList.add('kiss-emoji');
            emoji.textContent = '😘'; 
            
            // 1. Random Start Position (Across the entire viewport)
            emoji.style.left = Math.random() * 100 + 'vw'; 
            emoji.style.top = Math.random() * 100 + 'vh';  

            // 2. Random Movement Destination (Relative to its starting position)
            const randomX = (Math.random() * 600 - 300) + 'px'; 
            const randomY = (Math.random() * -600 - 600) + 'px'; 

            // Set CSS variables for the keyframes
            emoji.style.setProperty('--final-x', randomX);
            emoji.style.setProperty('--final-y', randomY);
            
            // Random delay for a staggered effect
            emoji.style.animationDelay = Math.random() * 1 + 's'; 

            document.body.appendChild(emoji);

            // Remove emoji after animation to clean up DOM
            emoji.addEventListener('animationend', () => {
                emoji.remove();
            });
        }
        
        // --- Dynamic Scroll Fade Logic (Original Functionality) ---
        function handleScrollFade() {
            const overlay = document.getElementById('scroll-overlay');
            if (overlay) {
                const scrollPosition = window.scrollY;
                // Fade from 0 (transparent) to 0.7 (semi-solid white) over 500px scroll depth
                const maxFadeScroll = 500;
                // Calculate opacity: 0 to 1 based on scroll position relative to maxFadeScroll
                let opacityFactor = Math.min(1, scrollPosition / maxFadeScroll);
                // The overlay will go from 0 opacity to a max of 0.7 opacity
                let fadeOpacity = opacityFactor * 0.7; 
                
                overlay.style.opacity = fadeOpacity;
            }
        }

        // Attach event listeners to the new buttons and original scroll logic
        window.addEventListener('scroll', handleScrollFade);
        window.addEventListener('load', handleScrollFade);
        window.addEventListener('load', () => {
            document.getElementById('tts-button').addEventListener('click', generateTTS);
            document.getElementById('generate-promise').addEventListener('click', generatePromise);
        });
    </script>
</body>
</html>



